dist: trusty
sudo: true
language: php
php:
#  - '5.4'
#  - '5.5'
  - '5.6.29'
  - '7.0.7'
  - '7.0.17'
#  - '7.1'
#  - hhvm
#  - nightly

services:
  - mysql

cache:
  directories:
    - $HOME/.composer/cache/files

env:
  matrix:
  - MAGENTO_VERSION=2.1.0
  - MAGENTO_VERSION=2.1.1
  - MAGENTO_VERSION=2.1.2
  - MAGENTO_VERSION=2.1.3
  - MAGENTO_VERSION=2.1.4
  - MAGENTO_VERSION=2.1.5

  global:
    - MYSQL_HOST=127.0.0.1
    - MYSQL_USER=magento
    - MYSQL_PASSWORD=magento
    - MAGENTO_PATH=../magento
    - MODULE_NAME=doofinder/doofinder-magento2
    - MAGENTO_ADMIN_FIRSTNAME=Admin
    - MAGENTO_ADMIN_LASTNAME=MyStore
    - MAGENTO_ADMIN_EMAIL=amdin@example.com
    - MAGENTO_ADMIN_USERNAME=admin
    - MAGENTO_ADMIN_PASSWORD=admin123
    - MAGENTO_TEST_CLEANUP=0
    - secure: YONkNzW+1zZgzScoqIFYO7AbfvBac2hAH5nvkCiBwVbCiq4UIT8dXdJQDM/VYylMROKlFYNyEUBQKOLteWc8iiUiAwa6oh2BZbE491t4dn6o85qfqqBch6+BCcbnUFqFD7gTc2qWLeeCyYUnxgv3STYIzx3sob2qkUy4w1rRebJeUKz66WgRQE/nvTdAVZ44Ttl0V5zxPqO2YxOA69I4qFaRSQgOSenSquoc7ekJCFGZz1/yGLeHlpRlL9VGoXL8qJUDtS4cQ/TA/DpCKCaAFXGTfqg/hx+3b/8ZQeYKxCf/7rNt1xjGG+92dJLe+kwgScGgdGP3vN7+n24Mzmt5VkGM1/fE7c3or5gKvD8K7tkfE3YwGDAGA+MrsM4L5Nq3m9MgwRAbK1IdYr1gppnCbHWnVb4L8yTC0zBl7gjQgCBzD/OD+soSGyCTKQjjLvEq1+HC8EBKWiu+6krzxPsoSTtp5x209SNNODOkGgxBYwvqIT2iOUxwtzlE2R7ZnvCUO+5CMV5ZqpF0e5Ybcca5jUoFmwgNxeM3mQ02lWcp3f9lZ+j2lStjB21x1rlnFC38JsCytrLTbkGFLA/jipeVUaEZA1XKLFgv/vW99hnQVjtP1xCmW36MeTfsih8ASyhRNZbfMcbXZi08a7ZM3ZiEujmqUlJNqqgjvgMJIemUodA=
    - secure: DfmHJm+tis7WTjtvJKnxxPlXrd7jbRNgRKzhOScaW2Jo3vHSm09WZKiLFyR9ZoHoAnKbft2cyKGRw2pPlfZBe9/GwUVhTp6ndFKuNDVFyoRoVMJb+B9TS/LLCqtOy+NsUV2l6lDfeU8XNuKY6cVpznaL3Vugc5AhWsG96M+eZesaOjvr9zp35Y92iHhiYHvh16WlBhw+6Jjz2sGFawIP1cjC3tge6KYQrpvI5Jd+1q943NtnAr+t2IobI0KuNPie2K49T1W5WBijSL7xqAnQoUsc/Svu2WahrLjxQnE5HUQ0G2xut884ZYwRNROMItLtSDl7Sr18ZREyuK8WBGwuNoAxkNCSRh++4m4rNAjl0KeuyI/wJlyNPzAbCBYHH+IxdC06qriK8BPejeoB4nRbZd7aUX1QjD6Lrskm4n2o30yOK98WkvEYUkmNTG0qUkFSA2gHCPbOAiRbt2rS3eFtDGsrZy4Fr6o/RdYnu9D2x3Jutc9USPMCrPTzJBhjfn3fc8yvfFxKfqSxSzB4jhgC06iSTXzlo4xv4fOYg2xrsHr8JFc3GLt+WiwtEq9g9FlUTXJN4U6KmVabCqSlYSfAfK6w4iqUQYIjUbYR8m51u/kyGJb3rFwWyXJIgtKMgfink8i3MW8u5u2f4X8hAvFEjSB2JKpAV+p3Sm23HNkYBgo=

before_install:
  - mysql -e 'CREATE DATABASE magento_integration_tests;'
  - mysql -e "GRANT ALL PRIVILEGES ON magento_integration_tests.* TO 'magento'@'localhost' IDENTIFIED BY 'magento';"
  - mysql -e 'FLUSH PRIVILEGES;'
  - composer config --global http-basic.repo.magento.com "$MAGENTO_AUTH_USER" "$MAGENTO_AUTH_PASSWORD"
  - phpenv config-rm xdebug.ini

install:
  - composer create-project --repository-url=https://repo.magento.com/ magento/project-community-edition "$MAGENTO_PATH" "$MAGENTO_VERSION"
  - composer config -d "$MAGENTO_PATH" minimum-stability "dev" 2>/dev/null
  - |-
    composer config -d "$MAGENTO_PATH" repositories.1 "{\"type\": \"path\", \"url\": \"$TRAVIS_BUILD_DIR\"}" 2>/dev/null
  - composer require -d "$MAGENTO_PATH" "$MODULE_NAME"
  - cp Test/ci/phpunit.unit.xml "$MAGENTO_PATH/dev/tests/unit/phpunit.xml"
  - cp Test/ci/phpunit.integration.xml "$MAGENTO_PATH/dev/tests/integration/phpunit.xml"
  - cp Test/ci/install-config-mysql.php "$MAGENTO_PATH/dev/tests/integration/etc/install-config-mysql.php"

script:
  - bash -c 'cd "$MAGENTO_PATH/dev/tests/unit" && php ../../../vendor/bin/phpunit'
  - bash -c 'cd "$MAGENTO_PATH/dev/tests/integration" && php ../../../vendor/bin/phpunit'

before_deploy:
  - git archive -o doofinder-magento2.zip $TRAVIS_TAG

deploy:
  provider: releases
  api_key:
    secure: NY99LD7CZoobwbGWsX3K+WHjxAv251rQY5IeEQ1PfIfbWzDknKcfG6n7w4v0Q2lH1xgOXfPeO2ZvP+pGIC9o9qyVR956goJxpUNb9pEk7bs+IgcnLFaMJ9fwQsDxf1ueMPaC3SMreqhH3lrFvgkAXXn4KfRUYGGqhkwiNLXpy5PTfYqv5PpZi2YHhV29ymrL2jnDy2X341PlnPcvtWWv8RhBzEEumlLvQba3TK30sA9heMA0VVb4v7N3ZYO/HJv55AthiYbmx70dtXWvsyt4cImXenMRd19qT9ZVsWD+5BRL1Uw4Tk8jNTb6+SsbX+yWm5h0CycnhFxfMwPOO5ZdLMDdz+bzOAEKQQXTQmnxbD32PYDi51mcOu2a0joczHE9g9TcmJt7uCblUVtfjWaUbJcyqRHZ4lBTImfI5BuPsARq0VqJuNmeTokWqiS3vfKIWuTcyU2D7SCAh0sQqJqei4mKAC5B9JULWlmMTBBS3lDZA2stIJaQ0NWWBRt3WpKTzBAGivDZsqrSrEDN6wAsgmrMSh2kHyJyavLPt25f4Ap+gXmq5viqaogKnl3e545UBtsxpFzP5D506JW/qVq2CUQNDFdWMylgAZn5VUcr+H4I7GVtZvgikB4O1+AW3g71MjwrujXgKo4ZiT9mWAFU7FBnDJhSk1q6QEI/Yo6sOn4=
  file: doofinder-magento2.zip
  skip_cleanup: true
  on:
    tags: true
    condition: $TRAVIS_TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+$
